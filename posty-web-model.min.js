/*!vim: et:ts=4:sw=4:sts=4 
* posty_webModel

* Copyright 2014 posty-soft.org
* Licensed under the LGPL v3
* https://www.gnu.org/licenses/lgpl.html
*/

"use strict";var app=angular.module("postySoft.models",[]),errorMsg=function(a){var b="";for(var c in a)a.hasOwnProperty(c)&&(b=b+". "+a[c]);return b.substr(2,b.length)+"."};app.factory("AlertService",["$timeout",function(a){var b=[],c=1e4,d=function(){b.splice(0,1)};return{addAlert:function(e,f){b.push({type:e,msg:f});a(d,c)},closeAlert:function(a){b.splice(a,1)},clearAlerts:function(){b=[]},alerts:function(){return b}}}]),app.factory("Servers",["Restangular",function(a){var b=[],c={url:"",key:""},d=c;return{add:function(a){b.push(a)},remove:function(a){var c=b.indexOf(a);c>-1&&b.splice(c,1)},currentServer:function(){return d},setCurrentServer:function(b){b!=d&&(d=b,a.setBaseUrl(b.url),a.setDefaultHeaders({"Content-Type":"application/json",auth_token:b.key}))},getList:function(){return b},moreThanOneServer:function(){return b.length>1},isValid:function(){return null!=d}}}]),app.factory("Domains",["Restangular","AlertService",function(a,b){var c={name:"all Domains"},d=c,e=[],f=[],g=[],h=function(){for(var a=0;a<g.length;a++)g[a].update()},i=function(a){for(var b=0;b<g.length;b++)if(g[b].getName()===a.getName())return!0;return!1},j=function(){e=[],f=[];var b=a.all("domains");b.getList().then(function(a){for(var b=0;b<a.length;b++)f.push(angular.copy(a[b])),e.push(a[b].virtual_domain)})},k=function(a){for(var b=0;b<f.length;b++)if(f[b].virtual_domain.id==a)return f[b].virtual_domain};return{ALL_DOMAINS:c,isValid:function(a){return a&&a!=c},allDomainsSelected:function(){return d==c},currentDomain:function(){return d},setCurrentDomain:function(a){a!=d&&(d=a,h())},create:function(e){var f=a.all("domains");f.post(e).then(function(){var a="New domain created: "+e.name;b.addAlert("success",a),d=c,j()},function(a){var c="There was an error saving the domain "+e.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",c)})},edit:function(c){var d=k(c.id),e=a.one("domains",d.name);e.name=c.name,e.put().then(function(){var a="Domain "+c.name+" updated!";b.addAlert("success",a),j()},function(a){var d="There was an error updating the domain "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d),j()})},remove:function(e){var f=a.one("domains",e.name);f.remove().then(function(){var a="Domain "+e.name+" deleted!";b.addAlert("success",a),e==d&&(d=c),j()},function(a){var c="There was an error deleting the domain "+e.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",c)})},getList:function(){return e},refresh:function(){j()},registerCurrentDomainObserver:function(a){i(a)||g.push(a)},unregisterCurrentDomainObserver:function(a){var b=g.indexOf(a);b>-1&&g.splice(b,1)}}}]),app.factory("DomainAliasses",["Restangular","AlertService","Domains",function(a,b,c){var d=[],e=null,f=function(){d=[],c.isValid(e)&&a.one("domains",e.name).all("aliases").getList().then(function(a){for(var b=0;b<a.length;b++)d.push(a[b].virtual_domain_alias)})};return{setDomain:function(a){e!=a&&(e=a)},getDomain:function(){return e},create:function(c){var d=a.one("domains",e.name).all("aliases");d.post(c).then(function(){var a="New domain alias created: "+c.name;b.addAlert("success",a),f()},function(a){var d="There was an error saving the domain alias "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},remove:function(c){var d=a.one("domains",e.name).one("aliases",c.name);d.remove().then(function(){var a="Domain alias "+c.name+" deleted!";b.addAlert("success",a),f()},function(a){var d="There was an error deleting the domain alias "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},getList:function(){return d},refresh:function(){f()}}}]),app.factory("Transports",["Restangular","AlertService",function(a,b){var c=[],d=[],e=function(){c=[],d=[],a.all("transports").getList().then(function(a){for(var b=0;b<a.length;b++)d.push(angular.copy(a[b])),c.push(a[b].virtual_transport)})},f=function(a){for(var b=0;b<d.length;b++)if(d[b].virtual_transport.id==a)return d[b].virtual_transport};return{create:function(c){var d=a.all("transports");d.post(c).then(function(){var a="New transport created: "+c.name;b.addAlert("success",a),e()},function(a){var d="There was an error saving the transport "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},edit:function(c){var d=f(c.id),g=a.one("transports",d.name);g.name=c.name,g.destination=c.destination,g.put().then(function(){var a="Transport "+c.name+" updated!";b.addAlert("success",a),e()},function(a){var d="There was an error updating the transport "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d),e()})},remove:function(c){var d=a.one("transports",c.name);d.remove().then(function(){var a="Transport "+c.name+" deleted!";b.addAlert("success",a),e()},function(a){var d="There was an error deleting the transport "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},getList:function(){return c},refresh:function(){e()}}}]),app.factory("Users",["Restangular","AlertService","Domains",function(a,b,c){var d=[],e=[],f=null,g=function(){d=[],e=[],c.isValid(f)&&a.one("domains",f.name).all("users").getList().then(function(a){for(var b=0;b<a.length;b++)e.push(angular.copy(a[b])),d.push(a[b].virtual_user)})},h=function(a){for(var b=0;b<e.length;b++)if(e[b].virtual_user.id==a)return e[b].virtual_user};return{isValid:function(a){return null!=a},setDomain:function(a){f!=a&&(f=a)},getDomain:function(){return f},create:function(c){var d=a.one("domains",f.name).all("users");d.post(c).then(function(){var a="New user created: "+c.name;b.addAlert("success",a),g()},function(a){var d="There was an error saving the user "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},edit:function(c){var d=h(c.id),e=a.one("domains",f.name).one("users",d.name);e.name=c.name,e.quota=c.quota,c.password!=e.password&&(e.password=c.password),e.put().then(function(){var a="User "+c.name+" updated!";b.addAlert("success",a),g()},function(a){var d="There was an error updating the user "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d),g()})},remove:function(c){var d=a.one("domains",f.name).one("users",c.name);d.remove().then(function(){var a="User "+c.name+" deleted!";b.addAlert("success",a),g()},function(a){var d="There was an error deleting the user "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},getList:function(){return d},refresh:function(){g()}}}]),app.factory("UserAliasses",["Restangular","AlertService","Domains","Users",function(a,b,c,d){var e=[],f=null,g=null,h=function(){e=[],c.isValid(f)&&d.isValid(g)&&a.one("domains",f.name).one("users",g.name).all("aliases").getList().then(function(a){for(var b=0;b<a.length;b++)e.push(a[b].virtual_user_alias)})};return{setDomain:function(a){f!=a&&(f=a)},getDomain:function(){return f},setUser:function(a){g!=a&&(g=a)},getUser:function(){return g},create:function(c){var d=a.one("domains",f.name).one("users",g.name).all("aliases");d.post(c).then(function(){var a="New user alias created: "+c.name;b.addAlert("success",a),h()},function(a){var d="There was an error saving the user alias "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},remove:function(c){var d=a.one("domains",f.name).one("users",g.name).one("aliases",c.name);d.remove().then(function(){var a="User alias "+c.name+" deleted!";b.addAlert("success",a),h()},function(a){var d="There was an error deleting the user alias "+c.name+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},getList:function(){return e},refresh:function(){h()}}}]),app.factory("Summaries",["Restangular",function(a){var b=[],c=function(){b=[],a.all("summary").getList().then(function(a){angular.forEach(a,function(a){var c=new Object;c.value=a.count,c.percent=a.count,c.name=a.name,c.caption=a.name+": "+a.count.toFixed(0),b.push(c)})})};return{getList:function(){return b},refresh:function(){c()}}}]),app.factory("ApiKeys",["Restangular","AlertService",function(a,b){var c=[],d=[],e=function(){c=[],d=[],a.all("api_keys").getList().then(function(a){for(var b=0;b<a.length;b++)d.push(angular.copy(a[b])),c.push(a[b].api_key)})};return{create:function(c){var d=a.all("api_keys");d.post(c).then(function(a){var c="New api-key created: "+a.apiKey.access_token;b.addAlert("success",c),e()},function(a){var c="There was an error saving the api-key "+a.apiKey.access_token+": \n"+errorMsg(a.data.error);b.addAlert("danger",c)})},edit:function(c){var d=a.one("api_keys",c.access_token);d.expires_at=c.expires_at,d.active=Number(c.active),d.put().then(function(){var a="Api-key "+c.access_token+" updated!";b.addAlert("success",a),e()},function(a){var d="There was an error updating the api-key "+c.access_token+": \n"+errorMsg(a.data.error);b.addAlert("danger",d),e()})},remove:function(c){var d=a.one("api_keys",c.access_token);d.remove().then(function(){var a="Api-key "+c.access_token+" deleted!";b.addAlert("success",a),e()},function(a){var d="There was an error deleting the api-key "+c.access_token+": \n"+errorMsg(a.data.error);b.addAlert("danger",d)})},getList:function(){return c},refresh:function(){e()},isExpired:function(a){var b=new Date,c=new Date(a.expires_at);return 0>c-b}}}]);
//# sourceMappingURL=posty-web-model.min.map